name: Dokken Drift Check

on:
  schedule:
    # Run on the 1st of every month at midnight UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  check-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Read versions from .mise.toml
        id: versions
        run: |
          PYTHON_VERSION=$(grep 'python = ' .mise.toml | cut -d'"' -f2)
          UV_VERSION=$(grep 'uv = ' .mise.toml | cut -d'"' -f2)
          echo "python=$PYTHON_VERSION" >> $GITHUB_OUTPUT
          echo "uv=$UV_VERSION" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
        with:
          python-version: ${{ steps.versions.outputs.python }}

      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7
        with:
          version: ${{ steps.versions.outputs.uv }}

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Check module READMEs for drift
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run dokken check --all --fix

      - name: Check project README for drift
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run dokken check . --doc-type project-readme --fix

      - name: Check style guide for drift
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: uv run dokken check . --doc-type style-guide --fix

      - name: Format markdown files
        run: uv run mdformat CLAUDE.md CONTRIBUTING.md README.md docs/ src/

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git-check.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          BRANCH="dokken/drift-fix-$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH"

          # Commit changes
          git add -A
          git commit -m "docs: fix documentation drift detected by dokken"

          # Push branch
          git push -u origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "docs: fix documentation drift" \
            --body "$(cat <<'EOF'
## Summary
- Documentation drift detected and fixed by automated dokken check
- Changes applied using `dokken check --fix`

## Modified Documentation
This PR may include updates to:
- Module READMEs (src/)
- Project README (README.md)
- Style guide (docs/style-guide.md)

## Review Checklist
- [ ] Review changes for accuracy
- [ ] Verify no sensitive information was added
- [ ] Confirm changes align with project style

---
*This PR was automatically generated by the monthly dokken drift check workflow.*
EOF
)"
